<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call of Cthulhu 7e NPC Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #e6e6e6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            border: 2px solid #8b4513;
        }

        .header h1 {
            color: #d4af37;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            margin-bottom: 10px;
        }

        .header p {
            font-style: italic;
            color: #c0c0c0;
        }

        .controls {
            text-align: center;
            margin-bottom: 30px;
        }

        .btn {
            background: linear-gradient(45deg, #8b4513, #a0522d);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin: 0 5px 10px 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            display: inline-block;
        }

        .btn:hover {
            background: linear-gradient(45deg, #a0522d, #8b4513);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }

        /* Print-specific styles */
        @media print {
            body {
                background: white !important;
                color: black !important;
                font-family: 'Times New Roman', serif;
                margin: 0;
                padding: 20px;
            }
            
            .no-print {
                display: none !important;
            }
            
            .character-sheet {
                background: white !important;
                border: 2px solid black !important;
                box-shadow: none !important;
                page-break-inside: avoid;
            }
            
            .stat-group, .derived-stats, .occupation-section, .background-section {
                background: white !important;
                border: 1px solid black !important;
            }
            
            .character-name {
                color: black !important;
                border-bottom: 2px solid black !important;
            }
            
            .stat-group h3, .derived-stats h3 {
                color: black !important;
                border-bottom: 1px solid black !important;
            }
            
            .stat-row {
                background: transparent !important;
                border-left: 3px solid black !important;
            }
            
            .background-trait {
                background: #f5f5f5 !important;
                border-left: 4px solid black !important;
            }
            
            .age-info {
                background: #f0f0f0 !important;
                border: 1px solid black !important;
            }
        }

        .character-sheet {
            background: linear-gradient(145deg, #2c2c2c, #1a1a1a);
            border: 3px solid #8b4513;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            display: none;
        }

        .character-sheet.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .character-name {
            text-align: center;
            font-size: 2.2em;
            color: #d4af37;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            padding-bottom: 15px;
            border-bottom: 2px solid #8b4513;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .stat-group {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #654321;
            border-radius: 10px;
            padding: 20px;
        }

        .stat-group h3 {
            color: #d4af37;
            margin-bottom: 15px;
            font-size: 1.4em;
            text-align: center;
            border-bottom: 1px solid #654321;
            padding-bottom: 8px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            border-left: 3px solid #8b4513;
        }

        .stat-name {
            font-weight: bold;
            color: #c0c0c0;
            text-transform: uppercase;
            font-size: 0.9em;
        }

        .stat-value {
            color: #ffffff;
            font-weight: bold;
            font-size: 1.1em;
        }

        .derived-stats {
            background: rgba(139, 69, 19, 0.2);
            border: 2px solid #8b4513;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .derived-stats h3 {
            color: #d4af37;
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        .skills-section, .occupation-section, .background-section {
            margin-top: 25px;
            background: rgba(0, 0, 0, 0.2);
            border: 2px solid #654321;
            border-radius: 10px;
            padding: 20px;
        }

        .occupation-skills {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .skill-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 12px;
            border-radius: 5px;
            border-left: 3px solid #d4af37;
            display: flex;
            justify-content: space-between;
        }

        .background-trait {
            background: rgba(139, 69, 19, 0.1);
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #8b4513;
        }

        .background-trait h4 {
            color: #d4af37;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .age-info {
            background: rgba(212, 175, 55, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #d4af37;
        }

        .age-effects {
            font-style: italic;
            color: #c0c0c0;
            margin-top: 8px;
            font-size: 0.9em;
        }

        .download-section {
            text-align: center;
            margin-top: 25px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 1px solid #654321;
        }

        .download-section h3 {
            color: #d4af37;
            margin-bottom: 15px;
        }

        .cthulhu-symbol {
            text-align: center;
            font-size: 3em;
            color: #8b4513;
            margin: 20px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #888;
            font-style: italic;
            border-top: 1px solid #654321;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header no-print">
            <h1>Call of Cthulhu 7th Edition</h1>
            <p>NPC Character Generator</p>
            <div class="cthulhu-symbol">ð“†—</div>
        </div>

        <div class="controls no-print">
            <button class="btn" onclick="generateCharacter()">Generate New Character</button>
            <button class="btn" onclick="downloadJSON()" id="jsonBtn" style="display:none;">Download JSON</button>
            <button class="btn" onclick="downloadMarkdown()" id="mdBtn" style="display:none;">Download Markdown</button>
            <button class="btn" onclick="downloadPrintHTML()" id="printBtn" style="display:none;">Download Print HTML</button>
            <button class="btn" onclick="window.print()" id="printDirectBtn" style="display:none;">Print Character</button>
        </div>

        <div class="character-sheet" id="characterSheet">
            <div class="character-name" id="characterName"></div>
            
            <div class="age-info" id="ageInfo"></div>

            <div class="stats-grid">
                <div class="stat-group">
                    <h3>Primary Characteristics</h3>
                    <div id="primaryStats"></div>
                </div>
                
                <div class="stat-group">
                    <h3>Secondary Attributes</h3>
                    <div id="secondaryStats"></div>
                </div>
            </div>

            <div class="derived-stats">
                <h3>Derived Attributes</h3>
                <div class="stats-grid">
                    <div id="derivedStats"></div>
                    <div id="combatStats"></div>
                </div>
            </div>

            <div class="occupation-section">
                <h3 style="color: #d4af37; text-align: center; margin-bottom: 15px;">Occupation</h3>
                <div class="stat-row">
                    <span class="stat-name">Profession</span>
                    <span class="stat-value" id="occupationName"></span>
                </div>
                <div class="stat-row">
                    <span class="stat-name">Credit Rating</span>
                    <span class="stat-value" id="creditRating"></span>
                </div>
                <div id="occupationSkills" class="occupation-skills"></div>
            </div>

            <div class="skills-section">
                <h3 style="color: #d4af37; text-align: center; margin-bottom: 15px;">Skill Points Available</h3>
                <div class="stat-row">
                    <span class="stat-name">Occupation Skill Points</span>
                    <span class="stat-value" id="occupationalPoints"></span>
                </div>
                <div class="stat-row">
                    <span class="stat-name">Personal Interest Points</span>
                    <span class="stat-value" id="personalPoints"></span>
                </div>
            </div>

            <div class="background-section">
                <h3 style="color: #d4af37; text-align: center; margin-bottom: 15px;">Background & Personality</h3>
                <div id="backgroundTraits"></div>
            </div>

            <div class="download-section no-print">
                <h3>Export Options</h3>
                <p>Generate a character above to enable download options</p>
            </div>
        </div>

        <div class="footer no-print">
            <p>"That is not dead which can eternal lie, and with strange aeons even death may die."</p>
            <p>- Call of Cthulhu 7th Edition NPC Generator</p>
        </div>
    </div>

    <script>
        let currentCharacter = null;

        // Occupations with their skills and credit ratings
        const occupations = {
            "Accountant": {
                skills: ["Accounting", "Law", "Library Use", "Listen", "Persuade", "Spot Hidden", "Any two other skills"],
                creditRating: [30, 70]
            },
            "Actor": {
                skills: ["Art/Craft (Acting)", "Disguise", "Drive Auto", "Listen", "Other Language", "Persuade", "Psychology", "Any one other skill"],
                creditRating: [20, 99]
            },
            "Antiquarian": {
                skills: ["Appraise", "Art/Craft", "History", "Library Use", "Other Language", "Spot Hidden", "Any two other skills"],
                creditRating: [30, 70]
            },
            "Archaeologist": {
                skills: ["Anthropology", "Appraise", "Art/Craft", "History", "Other Language", "Library Use", "Navigate", "Occult"],
                creditRating: [40, 70]
            },
            "Artist": {
                skills: ["Art/Craft (Primary)", "Art/Craft (Secondary)", "History", "Other Language", "Natural World", "Spot Hidden", "Any two other skills"],
                creditRating: [9, 50]
            },
            "Athlete": {
                skills: ["Climb", "Jump", "Ride", "Swim", "Throw", "Any three other skills as specialties"],
                creditRating: [9, 70]
            },
            "Author": {
                skills: ["Art/Craft (Literature)", "History", "Library Use", "Natural World", "Occult", "Other Language", "Own Language", "Psychology"],
                creditRating: [9, 30]
            },
            "Aviator": {
                skills: ["Electrical Repair", "Listen", "Mechanical Repair", "Navigate", "Operate Heavy Machinery", "Pilot (Aircraft)", "Spot Hidden", "Any one other skill"],
                creditRating: [30, 70]
            },
            "Bank Robber": {
                skills: ["Appraise", "Climb", "Drive Auto", "Fighting", "Firearms", "Jump", "Locksmith", "Stealth"],
                creditRating: [5, 65]
            },
            "Bartender": {
                skills: ["Accounting", "Fast Talk", "Listen", "Other Language", "Persuade", "Psychology", "Any two other skills"],
                creditRating: [8, 25]
            },
            "Big Game Hunter": {
                skills: ["Firearms", "Listen", "Natural World", "Navigate", "Other Language", "Spot Hidden", "Stealth", "Survival"],
                creditRating: [30, 80]
            },
            "Bounty Hunter": {
                skills: ["Drive Auto", "Fast Talk", "Fighting", "Firearms", "Law", "Listen", "Psychology", "Track"],
                creditRating: [9, 30]
            },
            "Butler/Valet": {
                skills: ["Accounting", "Appraise", "Drive Auto", "First Aid", "Listen", "Other Language", "Psychology", "Spot Hidden"],
                creditRating: [20, 40]
            },
            "Chauffeur": {
                skills: ["Accounting", "Drive Auto", "Electrical Repair", "Listen", "Mechanical Repair", "Navigate", "Spot Hidden", "Any one other skill"],
                creditRating: [15, 40]
            },
            "Clergyman": {
                skills: ["Accounting", "History", "Library Use", "Listen", "Other Language", "Persuade", "Psychology", "Any one other skill"],
                creditRating: [9, 60]
            },
            "Cowboy": {
                skills: ["Climb", "Fighting", "Firearms", "First Aid", "Jump", "Natural World", "Ride", "Throw"],
                creditRating: [8, 25]
            },
            "Craftsperson": {
                skills: ["Accounting", "Appraise", "Art/Craft", "Fast Talk", "Mechanical Repair", "Operate Heavy Machinery", "Persuade", "Spot Hidden"],
                creditRating: [20, 40]
            },
            "Criminal": {
                skills: ["Appraise", "Fast Talk", "Fighting", "Firearms", "Locksmith", "Psychology", "Stealth", "Any one other skill as a specialty"],
                creditRating: [5, 65]
            },
            "Dilettante": {
                skills: ["Art/Craft", "Firearms or Ride", "Other Language", "Persuade", "Any four other skills reflecting personal interests"],
                creditRating: [50, 99]
            },
            "Doctor of Medicine": {
                skills: ["First Aid", "Other Language (Latin)", "Medicine", "Psychology", "Science (Biology)", "Science (Pharmacy)", "Any two other skills as academic or personal specialties"],
                creditRating: [60, 90]
            },
            "Drifter": {
                skills: ["Climb", "Jump", "Listen", "Navigate", "Stealth", "Any three other skills"],
                creditRating: [0, 5]
            },
            "Engineer": {
                skills: ["Art/Craft (Technical Drawing)", "Electrical Repair", "Library Use", "Mechanical Repair", "Operate Heavy Machinery", "Science (Engineering)", "Science (Physics)", "Any one other skill"],
                creditRating: [30, 60]
            },
            "Entertainer": {
                skills: ["Art/Craft (Primary)", "Art/Craft (Secondary)", "Disguise", "Listen", "Psychology", "Any three other skills"],
                creditRating: [9, 70]
            },
            "Farmer": {
                skills: ["Drive Auto or Operate Heavy Machinery", "Electrical Repair", "First Aid", "Mechanical Repair", "Natural World", "Operate Heavy Machinery", "Repair", "Track"],
                creditRating: [9, 30]
            },
            "Federal Agent": {
                skills: ["Disguise", "Drive Auto", "Fast Talk", "Fighting", "Firearms", "Law", "Psychology", "Any one other skill"],
                creditRating: [50, 70]
            },
            "Gangster": {
                skills: ["Drive Auto", "Fast Talk", "Fighting", "Firearms", "Intimidate", "Law", "Psychology", "Any one other skill"],
                creditRating: [20, 80]
            },
            "Hobo": {
                skills: ["Climb", "Jump", "Listen", "Navigate", "Stealth", "Any three other skills"],
                creditRating: [0, 5]
            },
            "Investigator": {
                skills: ["Art/Craft (Photography)", "Disguise", "Fast Talk", "Law", "Library Use", "Listen", "Psychology", "Spot Hidden"],
                creditRating: [20, 45]
            },
            "Journalist": {
                skills: ["Art/Craft (Photography)", "History", "Library Use", "Own Language", "Persuade", "Psychology", "Any two other skills"],
                creditRating: [9, 30]
            },
            "Judge": {
                skills: ["Accounting", "History", "Intimidate", "Law", "Library Use", "Listen", "Persuade", "Psychology"],
                creditRating: [60, 90]
            },
            "Lawyer": {
                skills: ["Accounting", "Fast Talk", "Intimidate", "Law", "Library Use", "Listen", "Persuade", "Psychology"],
                creditRating: [30, 80]
            },
            "Librarian": {
                skills: ["Accounting", "Library Use", "Other Language", "Own Language", "Any four other skills as academic specialties"],
                creditRating: [35, 45]
            },
            "Missionary": {
                skills: ["Art/Craft", "First Aid", "Mechanical Repair", "Medicine", "Natural World", "Other Language", "Persuade", "Any one other skill"],
                creditRating: [0, 30]
            },
            "Musician": {
                skills: ["Art/Craft (Musical Instrument)", "Disguise", "Fast Talk", "Listen", "Psychology", "Any three other skills"],
                creditRating: [9, 30]
            },
            "Parapsychologist": {
                skills: ["Anthropology", "Art/Craft (Photography)", "History", "Library Use", "Occult", "Other Language", "Psychology", "Any one other skill"],
                creditRating: [9, 30]
            },
            "Pilot": {
                skills: ["Electrical Repair", "Listen", "Mechanical Repair", "Navigate", "Operate Heavy Machinery", "Physics", "Pilot (Aircraft)", "Spot Hidden"],
                creditRating: [20, 70]
            },
            "Police Detective": {
                skills: ["Art/Craft (Photography)", "Disguise", "Fast Talk", "Fighting", "Firearms", "Law", "Listen", "Psychology"],
                creditRating: [20, 50]
            },
            "Police Officer": {
                skills: ["Drive Auto", "Fast Talk", "Fighting", "Firearms", "First Aid", "Intimidate", "Law", "Psychology"],
                creditRating: [9, 30]
            },
            "Private Investigator": {
                skills: ["Art/Craft (Photography)", "Disguise", "Fast Talk", "Law", "Library Use", "Psychology", "Spot Hidden", "Any one other skill"],
                creditRating: [9, 30]
            },
            "Professor": {
                skills: ["Library Use", "Other Language", "Own Language", "Psychology", "Any four other skills as academic specialties"],
                creditRating: [20, 70]
            },
            "Psychiatrist": {
                skills: ["Fast Talk", "Listen", "Medicine", "Other Language", "Persuade", "Psychology", "Science (Biology)", "Any one other skill"],
                creditRating: [60, 90]
            },
            "Sailor": {
                skills: ["Climb", "Fighting", "Firearms", "First Aid", "Navigate", "Pilot (Boat)", "Swim", "Any one other skill"],
                creditRating: [9, 40]
            },
            "Salesperson": {
                skills: ["Accounting", "Drive Auto", "Fast Talk", "Jump", "Listen", "Persuade", "Psychology", "Any one other skill"],
                creditRating: [20, 50]
            },
            "Secretary": {
                skills: ["Accounting", "Art/Craft (Typing)", "Fast Talk", "Library Use", "Listen", "Other Language", "Own Language", "Psychology"],
                creditRating: [9, 30]
            },
            "Soldier": {
                skills: ["Climb", "Dodge", "Fighting", "Firearms", "First Aid", "Stealth", "Survival", "Any one other skill"],
                creditRating: [9, 30]
            },
            "Tribe Member": {
                skills: ["Climb", "Fighting", "Listen", "Natural World", "Occult", "Spot Hidden", "Swim", "Throw"],
                creditRating: [0, 15]
            },
            "Undertaker": {
                skills: ["Accounting", "Drive Auto", "Fast Talk", "History", "Intimidate", "Medicine", "Psychology", "Any one other skill"],
                creditRating: [20, 40]
            },
            "Union Activist": {
                skills: ["Accounting", "Fast Talk", "Fighting", "Law", "Listen", "Operate Heavy Machinery", "Persuade", "Psychology"],
                creditRating: [5, 30]
            },
            "Zealot": {
                skills: ["History", "Intimidate", "Other Language", "Persuade", "Psychology", "Stealth", "Any two other skills"],
                creditRating: [0, 30]
            }
        };

        // Age categories and their effects
        const ageCategories = {
            "15-19": { name: "Very Young", eduBonus: 0, appPenalty: 0, strConPenalty: 0, eduRolls: 1, skillChecks: 2 },
            "20-39": { name: "Young Adult", eduBonus: 0, appPenalty: 0, strConPenalty: 0, eduRolls: 1, skillChecks: 0 },
            "40-49": { name: "Middle Age", eduBonus: 5, appPenalty: 5, strConPenalty: 5, eduRolls: 2, skillChecks: 0 },
            "50-59": { name: "Mature", eduBonus: 10, appPenalty: 10, strConPenalty: 10, eduRolls: 3, skillChecks: 0 },
            "60-69": { name: "Senior", eduBonus: 15, appPenalty: 15, strConPenalty: 20, eduRolls: 4, skillChecks: 0 },
            "70-79": { name: "Elderly", eduBonus: 20, appPenalty: 20, strConPenalty: 40, eduRolls: 4, skillChecks: 0 },
            "80+": { name: "Very Elderly", eduBonus: 25, appPenalty: 25, strConPenalty: 80, eduRolls: 4, skillChecks: 0 }
        };

        // Background traits
        const personalityTraits = [
            "Ambitious and driven", "Cautious and careful", "Charming and charismatic", "Cynical and pessimistic",
            "Eccentric and unusual", "Friendly and outgoing", "Greedy and materialistic", "Honest and trustworthy",
            "Impulsive and reckless", "Intelligent and analytical", "Kind and compassionate", "Lazy and unmotivated",
            "Mysterious and secretive", "Nervous and anxious", "Optimistic and hopeful", "Paranoid and suspicious",
            "Quiet and reserved", "Rebellious and defiant", "Scholarly and bookish", "Superstitious and fearful"
        ];

        const ideologyBeliefs = [
            "Staunch patriot", "Religious fundamentalist", "Rationalist and skeptic", "Believer in progress",
            "Traditionalist", "Socialist ideals", "Anarchist tendencies", "Fatalist worldview",
            "Humanist philosophy", "Materialist outlook", "Spiritualist beliefs", "Nihilistic perspective",
            "Conservative values", "Liberal ideals", "Fascist sympathies", "Communist beliefs"
        ];

        const significantPeople = [
            "Parent or guardian", "Childhood friend", "First love", "Mentor or teacher", "Sibling",
            "Child or ward", "Partner or spouse", "Person who wronged them", "Fellow worker",
            "Person they saved", "Person who saved them", "Childhood enemy", "Famous person they admire",
            "Fellow enthusiast", "Rival in love", "Dependent family member"
        ];

        const meaningfulLocations = [
            "Childhood home", "Place of learning", "Place of work", "Place of meeting", "Peaceful place",
            "Exciting place", "Place of sorrow", "Birthplace of parent", "Family gathering place",
            "Place of power", "Sacred place", "Mysterious place", "Library or museum", "Grave or tomb",
            "Scenic beauty spot", "Country retreat"
        ];

        const treasuredPossessions = [
            "Family heirloom", "Weapon", "Pet", "Photograph", "Diary or journal", "Tool of trade",
            "Clothing item", "Jewelry", "Book", "Letter", "Map", "Lucky charm", "Collection",
            "Keepsake from loved one", "Religious item", "Artwork"
        ];

        // Name arrays for random generation
        const firstNames = [
            "Albert", "Arthur", "Charles", "Edgar", "Ernest", "Francis", "George", "Henry", "Howard", "James",
            "John", "Joseph", "Leonard", "Robert", "Thomas", "Walter", "William", "Alice", "Catherine", "Dorothy",
            "Elizabeth", "Helen", "Margaret", "Mary", "Nancy", "Patricia", "Ruth", "Sarah", "Susan", "Virginia"
        ];

        const lastNames = [
            "Anderson", "Brown", "Carter", "Davis", "Evans", "Fisher", "Green", "Harris", "Johnson", "King",
            "Lewis", "Miller", "Moore", "Parker", "Roberts", "Smith", "Taylor", "Thompson", "Walker", "White",
            "Williams", "Wilson", "Adams", "Baker", "Clark", "Cooper", "Hall", "Hill", "Jackson", "Jones"
        ];

        function rollDice(count, sides) {
            let total = 0;
            for (let i = 0; i < count; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }

        function generateRandomName() {
            const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
            const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
            return `${firstName} ${lastName}`;
        }

        function generateAge() {
            const ageRanges = Object.keys(ageCategories);
            const selectedRange = ageRanges[Math.floor(Math.random() * ageRanges.length)];
            
            let age;
            if (selectedRange === "15-19") age = 15 + Math.floor(Math.random() * 5);
            else if (selectedRange === "20-39") age = 20 + Math.floor(Math.random() * 20);
            else if (selectedRange === "40-49") age = 40 + Math.floor(Math.random() * 10);
            else if (selectedRange === "50-59") age = 50 + Math.floor(Math.random() * 10);
            else if (selectedRange === "60-69") age = 60 + Math.floor(Math.random() * 10);
            else if (selectedRange === "70-79") age = 70 + Math.floor(Math.random() * 10);
            else age = 80 + Math.floor(Math.random() * 10);
            
            return { age, category: selectedRange, effects: ageCategories[selectedRange] };
        }

        function selectOccupation() {
            const occupationNames = Object.keys(occupations);
            const selectedName = occupationNames[Math.floor(Math.random() * occupationNames.length)];
            const occupation = occupations[selectedName];
            
            // Generate credit rating within range
            const creditRange = occupation.creditRating;
            const creditRating = creditRange[0] + Math.floor(Math.random() * (creditRange[1] - creditRange[0] + 1));
            
            return {
                name: selectedName,
                skills: occupation.skills,
                creditRating: creditRating
            };
        }

        function generateBackgroundTraits() {
            return {
                personality: personalityTraits[Math.floor(Math.random() * personalityTraits.length)],
                ideology: ideologyBeliefs[Math.floor(Math.random() * ideologyBeliefs.length)],
                significantPerson: significantPeople[Math.floor(Math.random() * significantPeople.length)],
                meaningfulLocation: meaningfulLocations[Math.floor(Math.random() * meaningfulLocations.length)],
                treasuredPossession: treasuredPossessions[Math.floor(Math.random() * treasuredPossessions.length)]
            };
        }

        function applyAgeEffects(characteristics, ageEffects) {
            const modified = { ...characteristics };
            
            // Apply EDU bonus
            modified.edu = Math.min(99, modified.edu + ageEffects.eduBonus);
            
            // Apply APP penalty
            modified.app = Math.max(1, modified.app - ageEffects.appPenalty);
            
            // Apply STR/CON penalties
            const strConReduction = ageEffects.strConPenalty;
            const totalStrCon = modified.str + modified.con;
            const reductionAmount = Math.min(strConReduction, totalStrCon - 2); // Ensure at least 1 each
            
            // Distribute reduction randomly between STR and CON
            let strReduction = Math.floor(Math.random() * (reductionAmount + 1));
            let conReduction = reductionAmount - strReduction;
            
            // Make sure neither goes below 1
            if (modified.str - strReduction < 1) {
                conReduction += (strReduction - (modified.str - 1));
                strReduction = modified.str - 1;
            }
            if (modified.con - conReduction < 1) {
                strReduction += (conReduction - (modified.con - 1));
                conReduction = modified.con - 1;
            }
            
            modified.str = Math.max(1, modified.str - strReduction);
            modified.con = Math.max(1, modified.con - conReduction);
            
            return modified;
        }

        function calculateDamageBonus(str, siz) {
            const total = str + siz;
            if (total <= 64) return "-2";
            if (total <= 84) return "-1";
            if (total <= 124) return "0";
            if (total <= 164) return "+1d4";
            if (total <= 204) return "+1d6";
            if (total <= 284) return "+2d6";
            if (total <= 364) return "+3d6";
            if (total <= 444) return "+4d6";
            return "+5d6";
        }

        function calculateBuild(str, siz) {
            const total = str + siz;
            if (total <= 64) return -2;
            if (total <= 84) return -1;
            if (total <= 124) return 0;
            if (total <= 164) return 1;
            if (total <= 204) return 2;
            if (total <= 284) return 3;
            if (total <= 364) return 4;
            if (total <= 444) return 5;
            return 6;
        }

        function generateCharacter() {
            // Generate age first
            const ageData = generateAge();
            
            // Generate base characteristics (3d6 * 5 for 7e)
            let characteristics = {
                str: rollDice(3, 6) * 5,
                con: rollDice(3, 6) * 5,
                siz: (rollDice(2, 6) + 6) * 5,
                dex: rollDice(3, 6) * 5,
                app: rollDice(3, 6) * 5,
                int: (rollDice(2, 6) + 6) * 5,
                pow: rollDice(3, 6) * 5,
                edu: (rollDice(2, 6) + 6) * 5
            };
            
            // Apply age effects to characteristics
            characteristics = applyAgeEffects(characteristics, ageData.effects);
            
            // Select occupation
            const occupation = selectOccupation();
            
            // Generate background traits
            const background = generateBackgroundTraits();
            
            // Calculate derived attributes
            const hp = Math.floor((characteristics.con + characteristics.siz) / 10);
            const mp = Math.floor(characteristics.pow / 5);
            const sanity = characteristics.pow;
            const luck = rollDice(3, 6) * 5;
            const damageBonus = calculateDamageBonus(characteristics.str, characteristics.siz);
            const build = calculateBuild(characteristics.str, characteristics.siz);
            const moveRate = calculateMoveRate(characteristics.str, characteristics.dex, characteristics.siz);
            
            // Calculate skill points (7e rules)
            const occupationalPoints = characteristics.edu * 4;
            const personalPoints = characteristics.int * 2;

            currentCharacter = {
                name: generateRandomName(),
                age: ageData,
                occupation: occupation,
                background: background,
                characteristics: characteristics,
                attributes: {
                    hp, mp, sanity, luck, damageBonus, build, moveRate
                },
                skillPoints: {
                    occupational: occupationalPoints,
                    personal: personalPoints
                },
                generated: new Date().toISOString()
            };

            displayCharacter();
        }


        function calculateMoveRate(str, dex, siz) {
            if (str < siz && dex < siz) return 7;
            if (str > siz || dex > siz) return 9;
            return 8;
        }

        function displayCharacter() {
            if (!currentCharacter) return;

            const char = currentCharacter;
            
            document.getElementById('characterName').textContent = char.name;
            
            // Age information
            const ageInfo = document.getElementById('ageInfo');
            ageInfo.innerHTML = `
                <strong>Age:</strong> ${char.age.age} years old (${char.age.effects.name})
                <div class="age-effects">
                    Age Effects: EDU +${char.age.effects.eduBonus}, APP -${char.age.effects.appPenalty}, STR/CON -${char.age.effects.strConPenalty}
                </div>
            `;
            
            // Primary stats
            const primaryStats = document.getElementById('primaryStats');
            primaryStats.innerHTML = `
                <div class="stat-row">
                    <span class="stat-name">Strength (STR)</span>
                    <span class="stat-value">${char.characteristics.str}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-name">Constitution (CON)</span>
                    <span class="stat-value">${char.characteristics.con}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-name">Size (SIZ)</span>
                    <span class="stat-value">${char.characteristics.siz}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-name">Dexterity (DEX)</span>
                    <span class="stat-value">${char.characteristics.dex}</span>
                </div>
            `;

            // Secondary stats
            const secondaryStats = document.getElementById('secondaryStats');
            secondaryStats.innerHTML = `
                <div class="stat-row">
                    <span class="stat-name">Appearance (APP)</span>
                    <span class="stat-value">${char.characteristics.app}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-name">Intelligence (INT)</span>
                    <span class="stat-value">${char.characteristics.int}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-name">Power (POW)</span>
                    <span class="stat-value">${char.characteristics.pow}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-name">Education (EDU)</span>
                    <span class="stat-value">${char.characteristics.edu}</span>
                </div>
            `;

            // Derived stats
            const derivedStats = document.getElementById('derivedStats');
            derivedStats.innerHTML = `
                <div class="stat-row">
                    <span class="stat-name">Hit Points</span>
                    <span class="stat-value">${char.attributes.hp}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-name">Magic Points</span>
                    <span class="stat-value">${char.attributes.mp}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-name">Sanity</span>
                    <span class="stat-value">${char.attributes.sanity}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-name">Luck</span>
                    <span class="stat-value">${char.attributes.luck}</span>
                </div>
            `;

            // Combat stats
            const combatStats = document.getElementById('combatStats');
            combatStats.innerHTML = `
                <div class="stat-row">
                    <span class="stat-name">Damage Bonus</span>
                    <span class="stat-value">${char.attributes.damageBonus}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-name">Build</span>
                    <span class="stat-value">${char.attributes.build}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-name">Move Rate</span>
                    <span class="stat-value">${char.attributes.moveRate}</span>
                </div>
            `;

            // Occupation information
            document.getElementById('occupationName').textContent = char.occupation.name;
            document.getElementById('creditRating').textContent = char.occupation.creditRating;
            
            const occupationSkills = document.getElementById('occupationSkills');
            occupationSkills.innerHTML = char.occupation.skills.map(skill => 
                `<div class="skill-item">
                    <span>${skill}</span>
                    <span>Base + Bonus</span>
                </div>`
            ).join('');

            // Skill points
            document.getElementById('occupationalPoints').textContent = char.skillPoints.occupational;
            document.getElementById('personalPoints').textContent = char.skillPoints.personal;

            // Background traits
            const backgroundTraits = document.getElementById('backgroundTraits');
            backgroundTraits.innerHTML = `
                <div class="background-trait">
                    <h4>Personality</h4>
                    <p>${char.background.personality}</p>
                </div>
                <div class="background-trait">
                    <h4>Ideology & Beliefs</h4>
                    <p>${char.background.ideology}</p>
                </div>
                <div class="background-trait">
                    <h4>Significant Person</h4>
                    <p>${char.background.significantPerson}</p>
                </div>
                <div class="background-trait">
                    <h4>Meaningful Location</h4>
                    <p>${char.background.meaningfulLocation}</p>
                </div>
                <div class="background-trait">
                    <h4>Treasured Possession</h4>
                    <p>${char.background.treasuredPossession}</p>
                </div>
            `;

            // Show character sheet and download buttons
            document.getElementById('characterSheet').classList.add('active');
            document.getElementById('jsonBtn').style.display = 'inline-block';
            document.getElementById('mdBtn').style.display = 'inline-block';
            document.getElementById('printBtn').style.display = 'inline-block';
            document.getElementById('printDirectBtn').style.display = 'inline-block';
        }

        function downloadPrintHTML() {
            if (!currentCharacter) return;
            
            const char = currentCharacter;
            const printHTML = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${char.name} - Call of Cthulhu 7e Character</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Times New Roman', serif;
            line-height: 1.4;
            color: #333;
            background: white;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .character-header {
            text-align: center;
            border-bottom: 3px solid #000;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .character-name {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2em;
            font-style: italic;
            color: #666;
        }

        .section {
            margin-bottom: 25px;
            border: 2px solid #000;
            padding: 15px;
        }

        .section-title {
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 1px solid #000;
            padding-bottom: 5px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-group {
            border: 1px solid #000;
            padding: 10px;
        }

        .stat-group-title {
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
            text-decoration: underline;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dotted #ccc;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-name {
            font-weight: bold;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 5px 0;
            border-bottom: 1px dotted #ccc;
        }

        .info-label {
            font-weight: bold;
            width: 40%;
        }

        .occupation-skills {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
            margin-top: 10px;
        }

        .skill-item {
            padding: 3px 5px;
            border: 1px solid #ccc;
            font-size: 0.9em;
        }

        .background-trait {
            margin-bottom: 15px;
            padding: 10px;
            border-left: 4px solid #000;
            background: #f9f9f9;
        }

        .trait-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .age-info {
            background: #f0f0f0;
            padding: 10px;
            border: 1px solid #000;
            margin-bottom: 15px;
            text-align: center;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #000;
            font-style: italic;
            color: #666;
        }

        @media print {
            body {
                padding: 10px;
            }
            
            .section {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="character-header">
        <div class="character-name">${char.name}</div>
        <div class="subtitle">Call of Cthulhu 7th Edition NPC</div>
        <div style="margin-top: 10px; font-size: 0.9em;">Generated: ${new Date(char.generated).toLocaleDateString()}</div>
    </div>

    <div class="age-info">
        <strong>Age:</strong> ${char.age.age} years old (${char.age.effects.name})<br>
        <small>Age Effects: EDU +${char.age.effects.eduBonus}, APP -${char.age.effects.appPenalty}, STR/CON -${char.age.effects.strConPenalty}</small>
    </div>

    <div class="section">
        <div class="section-title">Characteristics</div>
        <div class="stats-grid">
            <div class="stat-group">
                <div class="stat-group-title">Primary</div>
                <div class="stat-row">
                    <span class="stat-name">Strength (STR)</span>
                    <span>${char.characteristics.str}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-name">Constitution (CON)</span>
                    <span>${char.characteristics.con}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-name">Size (SIZ)</span>
                    <span>${char.characteristics.siz}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-name">Dexterity (DEX)</span>
                    <span>${char.characteristics.dex}</span>
                </div>
            </div>
            <div class="stat-group">
                <div class="stat-group-title">Secondary</div>
                <div class="stat-row">
                    <span class="stat-name">Appearance (APP)</span>
                    <span>${char.characteristics.app}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-name">Intelligence (INT)</span>
                    <span>${char.characteristics.int}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-name">Power (POW)</span>
                    <span>${char.characteristics.pow}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-name">Education (EDU)</span>
                    <span>${char.characteristics.edu}</span>
                </div>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">Derived Attributes</div>
        <div class="stats-grid">
            <div class="stat-group">
                <div class="stat-group-title">Core Attributes</div>
                <div class="stat-row">
                    <span class="stat-name">Hit Points</span>
                    <span>${char.attributes.hp}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-name">Magic Points</span>
                    <span>${char.attributes.mp}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-name">Sanity</span>
                    <span>${char.attributes.sanity}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-name">Luck</span>
                    <span>${char.attributes.luck}</span>
                </div>
            </div>
            <div class="stat-group">
                <div class="stat-group-title">Combat</div>
                <div class="stat-row">
                    <span class="stat-name">Damage Bonus</span>
                    <span>${char.attributes.damageBonus}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-name">Build</span>
                    <span>${char.attributes.build}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-name">Move Rate</span>
                    <span>${char.attributes.moveRate}</span>
                </div>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">Occupation: ${char.occupation.name}</div>
        <div class="info-row">
            <span class="info-label">Credit Rating:</span>
            <span>${char.occupation.creditRating}</span>
        </div>
        <div class="info-row">
            <span class="info-label">Occupation Skills:</span>
            <span></span>
        </div>
        <div class="occupation-skills">
            ${char.occupation.skills.map(skill => `<div class="skill-item">${skill}</div>`).join('')}
        </div>
    </div>

    <div class="section">
        <div class="section-title">Skill Points</div>
        <div class="info-row">
            <span class="info-label">Occupation Skill Points:</span>
            <span>${char.skillPoints.occupational}</span>
        </div>
        <div class="info-row">
            <span class="info-label">Personal Interest Points:</span>
            <span>${char.skillPoints.personal}</span>
        </div>
    </div>

    <div class="section">
        <div class="section-title">Background & Personality</div>
        <div class="background-trait">
            <div class="trait-title">Personality</div>
            <div>${char.background.personality}</div>
        </div>
        <div class="background-trait">
            <div class="trait-title">Ideology & Beliefs</div>
            <div>${char.background.ideology}</div>
        </div>
        <div class="background-trait">
            <div class="trait-title">Significant Person</div>
            <div>${char.background.significantPerson}</div>
        </div>
        <div class="background-trait">
            <div class="trait-title">Meaningful Location</div>
            <div>${char.background.meaningfulLocation}</div>
        </div>
        <div class="background-trait">
            <div class="trait-title">Treasured Possession</div>
            <div>${char.background.treasuredPossession}</div>
        </div>
    </div>

    <div class="footer">
        <p>"That is not dead which can eternal lie, and with strange aeons even death may die."</p>
        <p>- H.P. Lovecraft</p>
        <p style="margin-top: 10px; font-size: 0.8em;">Character generated using Call of Cthulhu 7th Edition rules</p>
    </div>
</body>
</html>`;
            
            const dataBlob = new Blob([printHTML], {type: 'text/html'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${char.name.replace(/\s+/g, '_').toLowerCase()}_character_sheet.html`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function downloadJSON() {
            if (!currentCharacter) return;
            
            const dataStr = JSON.stringify(currentCharacter, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${currentCharacter.name.replace(/\s+/g, '_').toLowerCase()}_coc7e.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function downloadMarkdown() {
            if (!currentCharacter) return;
            
            const char = currentCharacter;
            const markdown = `# ${char.name}
*Call of Cthulhu 7th Edition NPC*

Generated on: ${new Date(char.generated).toLocaleDateString()}

## Basic Information

- **Age:** ${char.age.age} years old (${char.age.effects.name})
- **Occupation:** ${char.occupation.name}
- **Credit Rating:** ${char.occupation.creditRating}

### Age Effects Applied
- Education: +${char.age.effects.eduBonus}
- Appearance: -${char.age.effects.appPenalty}  
- Strength/Constitution: -${char.age.effects.strConPenalty}

## Characteristics

| Characteristic | Value |
|----------------|-------|
| Strength (STR) | ${char.characteristics.str} |
| Constitution (CON) | ${char.characteristics.con} |
| Size (SIZ) | ${char.characteristics.siz} |
| Dexterity (DEX) | ${char.characteristics.dex} |
| Appearance (APP) | ${char.characteristics.app} |
| Intelligence (INT) | ${char.characteristics.int} |
| Power (POW) | ${char.characteristics.pow} |
| Education (EDU) | ${char.characteristics.edu} |

## Derived Attributes

| Attribute | Value |
|-----------|-------|
| Hit Points | ${char.attributes.hp} |
| Magic Points | ${char.attributes.mp} |
| Sanity | ${char.attributes.sanity} |
| Luck | ${char.attributes.luck} |
| Damage Bonus | ${char.attributes.damageBonus} |
| Build | ${char.attributes.build} |
| Move Rate | ${char.attributes.moveRate} |

## Occupation: ${char.occupation.name}

**Credit Rating:** ${char.occupation.creditRating}

### Occupation Skills:
${char.occupation.skills.map(skill => `- ${skill}`).join('\n')}

## Skill Points

- **Occupation Skill Points:** ${char.skillPoints.occupational}
- **Personal Interest Points:** ${char.skillPoints.personal}

## Background & Personality

### Personality Trait
${char.background.personality}

### Ideology & Beliefs  
${char.background.ideology}

### Significant Person
${char.background.significantPerson}

### Meaningful Location
${char.background.meaningfulLocation}

### Treasured Possession
${char.background.treasuredPossession}

## Notes

*This character was generated using the Call of Cthulhu 7th Edition rules with age modifications applied.*

---
*"The oldest and strongest emotion of mankind is fear, and the oldest and strongest kind of fear is fear of the unknown." - H.P. Lovecraft*
`;
            
            const dataBlob = new Blob([markdown], {type: 'text/markdown'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${char.name.replace(/\s+/g, '_').toLowerCase()}_coc7e.md`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // Generate initial character
        window.onload = function() {
            generateCharacter();
        };
    </script>
</body>
</html>
